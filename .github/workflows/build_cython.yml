# 工作流名称
name: Run py2sec Script on Windows

# 触发条件：仅手动触发
on:
  workflow_dispatch:

# 工作流任务配置
jobs:
  build-and-run:
    # 指定运行环境为 Windows 10 兼容的 Windows Server 2022
    runs-on: windows-2022
    timeout-minutes: 30

    steps:
      # 步骤1：拉取代码仓库到运行环境
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装并配置 VC BuildTools（修复版本问题）
      - name: Set up MSVC Build Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          # 使用兼容的工具集版本（不指定具体小版本，自动匹配环境中的最新版）
          toolset: 14.3
          arch: x64
          # 仅指定核心组件，避免版本冲突
          components: Microsoft.VisualStudio.Component.VC.Tools.x86.x64

      # 步骤3：验证VC环境是否配置成功
      - name: Verify MSVC Environment
        run: |
          cl.exe
          echo %VCINSTALLDIR%
        shell: cmd

      # 步骤4：设置 Python 3.12 环境
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          architecture: 'x64'

      # 步骤5：验证Python和pip版本
      - name: Verify Python installation
        run: |
          python --version
          pip --version

      # 步骤6：升级pip并安装Cython
      - name: Install Cython
        run: |
          python -m pip install --upgrade pip
          pip install cython

      # 步骤7：验证Cython安装
      - name: Verify Cython installation
        run: python -c "import cython; print('Cython version:', cython.__version__)"

      # 步骤8：执行目标Python脚本
      - name: Run py2sec.py script
        run: |
          # 确认脚本路径存在
          if (Test-Path "py2sec.py") {
              Write-Host "py2sec.py found"
          } else {
              Write-Host "py2sec.py not found in current directory"
              exit 1
          }
          # 执行目标命令
          python py2sec.py -f example/test1.py -r
        shell: pwsh
