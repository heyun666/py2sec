# 工作流名称
name: Run py2sec Script on Windows

# 触发条件：仅手动触发
on:
  workflow_dispatch:

# 工作流任务配置
jobs:
  build-and-run:
    # 指定运行环境为 Windows 10
    runs-on: windows-2022  # GitHub Actions 中 windows-2022 对应 Windows Server 2022，兼容 Windows 10 环境
    timeout-minutes: 30  # 设置超时时间，避免无限运行

    steps:
      # 步骤1：拉取代码仓库到运行环境
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装 Visual Studio Build Tools (VC BuildTools)
      - name: Install VC BuildTools
        uses: ilammy/msvc-dev-cmd@v1
        with:
          # 指定需要安装的组件，包含C++构建必需的工具链
          toolset: 14.38
          arch: x64
          # 安装VC BuildTools核心组件
          components: Microsoft.VisualStudio.Component.VC.Tools.x86.x64,Microsoft.VisualStudio.Component.Windows10SDK.19041

      # 步骤3：设置 Python 3.12 环境
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # 指定Python版本
          architecture: 'x64'     # 64位架构

      # 步骤4：验证Python和pip版本，确保环境正确
      - name: Verify Python installation
        run: |
          python --version
          pip --version

      # 步骤5：升级pip并安装Cython
      - name: Install Cython
        run: |
          python -m pip install --upgrade pip
          pip install cython

      # 步骤6：验证Cython安装
      - name: Verify Cython installation
        run: python -c "import cython; print('Cython version:', cython.__version__)"

      # 步骤7：执行目标Python脚本
      - name: Run py2sec.py script
        run: |
          # 确认脚本路径存在（可选，用于调试）
          if (Test-Path "py2sec.py") {
              Write-Host "py2sec.py found"
          } else {
              Write-Host "py2sec.py not found in current directory"
              exit 1
          }
          # 执行目标命令
          python py2sec.py -f example/test1.py -r
        shell: pwsh
